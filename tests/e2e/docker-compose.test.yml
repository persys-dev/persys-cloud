services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    command: ["etcd", "--advertise-client-urls=http://etcd:2379", "--listen-client-urls=http://0.0.0.0:2379"]
    ports:
      - "2379:2379"
    networks:
      - persys-cloud-test

  compute-agent:
    build:
      context: ../../compute-agent
      dockerfile: Dockerfile
    environment:
      - PERSYS_VAULT_ENABLED=false
      - PERSYS_TLS_ENABLED=false
      - PERSYS_GRPC_PORT=50051
      - PERSYS_LOG_LEVEL=info
      - PERSYS_RECONCILE_ENABLED=false
      - PERSYS_VM_ENABLED=false
      - PERSYS_SCHEDULER_INSECURE=true
      - PERSYS_SCHEDULER_ADDR=persys-scheduler:8085
    user: "0:0"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "50051:50051"
      - "8080:8080"
    networks:
      - persys-cloud-test

  persys-scheduler:
    build:
      context: ../../persys-scheduler
      dockerfile: Dockerfile
    command: ["./persys-scheduler", "-insecure"]
    environment:
      - PERSYS_VAULT_ENABLED=false
      - ETCD_ENDPOINTS=etcd:2379
      - GRPC_PORT=8085
      - METRICS_PORT=8084
    ports:
      - "8084:8084"
      - "8085:8085"
    depends_on:
      - etcd
      - compute-agent
    networks:
      - persys-cloud-test

  test-client:
    build:
      context: ../../
      dockerfile: tests/e2e/Dockerfile.test-client
    environment:
      - SCHEDULER_METRICS_URL=http://persys-scheduler:8084
      - SCHEDULER_GRPC_ADDR=persys-scheduler:8085
      - AGENT_METRICS_URL=http://compute-agent:8080
      - TEST_WORKLOAD_ID=e2e-workload-1
    depends_on:
      - persys-scheduler
      - compute-agent
    networks:
      - persys-cloud-test
    command: ["./test-runner"]

networks:
  persys-cloud-test:
